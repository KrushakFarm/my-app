<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Farmer Login - KrushakFarm</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f7f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .login-container {
      background: white;
      padding: 2rem 3rem;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    h2 {
      text-align: center;
      color: #2d7a2d;
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: bold;
      color: #333;
    }
    input[type="email"],
    input[type="password"],
    input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1.2rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
      transition: border-color 0.3s ease;
    }
    input[type="email"]:focus,
    input[type="password"]:focus,
    input[type="text"]:focus {
      outline: none;
      border-color: #2d7a2d;
      box-shadow: 0 0 0 2px rgba(45, 122, 45, 0.2);
    }
    button {
      width: 100%;
      background-color: #2d7a2d;
      color: white;
      font-size: 1.1rem;
      padding: 0.75rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin-bottom: 1rem;
    }
    button:hover:not(:disabled) {
      background-color: #246b24;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .form-toggle {
      text-align: center;
      margin-top: 1rem;
      color: #666;
    }
    .form-toggle a {
      color: #2d7a2d;
      text-decoration: none;
      font-weight: bold;
    }
    .form-toggle a:hover {
      text-decoration: underline;
    }
    .hidden {
      display: none;
    }
    .message {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    .success-message {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .warning-message {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .password-strength {
      font-size: 0.8rem;
      margin-top: -1rem;
      margin-bottom: 1rem;
    }
    .strength-weak { color: #dc3545; }
    .strength-medium { color: #ffc107; }
    .strength-strong { color: #28a745; }
    .verification-notice {
      background-color: #e3f2fd;
      color: #0d47a1;
      border: 1px solid #bbdefb;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      text-align: center;
    }
    .resend-btn {
      background-color: #17a2b8;
      margin-top: 0.5rem;
    }
    .resend-btn:hover:not(:disabled) {
      background-color: #138496;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <!-- Login Form -->
    <div id="login-form">
      <h2>Farmer Login</h2>
      
      <div id="login-message"></div>
      
      <form id="farmer-login-form">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" name="email" placeholder="farmer@email.com" required />

        <label for="login-password">Password</label>
        <input type="password" id="login-password" name="password" placeholder="Enter your password" required />

        <button type="submit" id="login-btn">Login</button>
      </form>
      
      <div class="form-toggle">
        New farmer? <a href="#" id="show-register">Register here</a>
      </div>
    </div>

    <!-- Register Form -->
    <div id="register-form" class="hidden">
      <h2>Farmer Registration</h2>
      
      <div id="register-message"></div>
      
      <form id="farmer-register-form">
        <label for="register-name">Full Name</label>
        <input type="text" id="register-name" name="name" placeholder="Enter your full name" required />
        
        <label for="register-email">Email</label>
        <input type="email" id="register-email" name="email" placeholder="farmer@email.com" required />

        <label for="register-password">Password</label>
        <input type="password" id="register-password" name="password" 
               placeholder="Create a strong password" required 
               oninput="checkPasswordStrength(this.value)" />
        <div id="password-strength" class="password-strength"></div>

        <button type="submit" id="register-btn">Register as Farmer</button>
      </form>
      
      <div class="form-toggle">
        Already have an account? <a href="#" id="show-login">Login here</a>
      </div>
    </div>

    <!-- Email Verification Form -->
    <div id="verification-form" class="hidden">
      <h2>Email Verification Required</h2>
      
      <div class="verification-notice">
        <p><strong>ðŸ“§ Check Your Email!</strong></p>
        <p>We've sent a verification link to your email address. Please check your inbox (and spam folder) and click the verification link to activate your account.</p>
      </div>
      
      <div id="verification-message"></div>
      
      <form id="resend-verification-form">
        <label for="resend-email">Email Address</label>
        <input type="email" id="resend-email" name="email" placeholder="Enter your email" required readonly />
        
        <button type="submit" class="resend-btn" id="resend-btn">Resend Verification Email</button>
        <button type="button" id="back-to-login">Back to Login</button>
      </form>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:5000/api";
    
    // Form references
    const loginFormDiv = document.getElementById('login-form');
    const registerFormDiv = document.getElementById('register-form');
    const verificationFormDiv = document.getElementById('verification-form');
    const loginForm = document.getElementById('farmer-login-form');
    const registerForm = document.getElementById('farmer-register-form');
    const resendForm = document.getElementById('resend-verification-form');
    
    // Show message function
    function showMessage(elementId, message, type = 'error') {
      const messageDiv = document.getElementById(elementId);
      messageDiv.innerHTML = `<div class="${type}-message">${message}</div>`;
    }
    
    // Clear message function
    function clearMessage(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }
    
    // Toggle forms
    document.getElementById('show-register').addEventListener('click', (e) => {
      e.preventDefault();
      loginFormDiv.classList.add('hidden');
      registerFormDiv.classList.remove('hidden');
      verificationFormDiv.classList.add('hidden');
      clearMessage('login-message');
    });
    
    document.getElementById('show-login').addEventListener('click', (e) => {
      e.preventDefault();
      registerFormDiv.classList.add('hidden');
      loginFormDiv.classList.remove('hidden');
      verificationFormDiv.classList.add('hidden');
      clearMessage('register-message');
    });
    
    document.getElementById('back-to-login').addEventListener('click', () => {
      verificationFormDiv.classList.add('hidden');
      loginFormDiv.classList.remove('hidden');
      clearMessage('verification-message');
    });

    // Password strength checker
    function checkPasswordStrength(password) {
      const strengthDiv = document.getElementById('password-strength');
      
      if (password.length === 0) {
        strengthDiv.innerHTML = '';
        return;
      }
      
      let score = 0;
      let feedback = [];
      
      // Length check
      if (password.length >= 8) score++;
      else feedback.push('at least 8 characters');
      
      // Uppercase check
      if (/[A-Z]/.test(password)) score++;
      else feedback.push('uppercase letter');
      
      // Lowercase check
      if (/[a-z]/.test(password)) score++;
      else feedback.push('lowercase letter');
      
      // Number check
      if (/\d/.test(password)) score++;
      else feedback.push('number');
      
      // Special character check
      if (/[@$!%*?&]/.test(password)) score++;
      else feedback.push('special character');
      
      let strengthText, className;
      
      if (score < 3) {
        strengthText = 'Weak - Missing: ' + feedback.join(', ');
        className = 'strength-weak';
      } else if (score < 5) {
        strengthText = 'Medium - Missing: ' + feedback.join(', ');
        className = 'strength-medium';
      } else {
        strengthText = 'Strong password âœ“';
        className = 'strength-strong';
      }
      
      strengthDiv.innerHTML = `<span class="${className}">${strengthText}</span>`;
    }

    // Login form handler
    loginForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const submitBtn = document.getElementById('login-btn');
      
      clearMessage('login-message');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';
      
      try {
        const response = await fetch(`${API_URL}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // Check if user is a farmer
          if (data.user.role !== 'farmer') {
            throw new Error('Only farmers can login here. Please use the customer login on the main website.');
          }
          
          // Store auth token
          localStorage.setItem('authToken', data.token);
          localStorage.setItem('user', JSON.stringify(data.user));
          
          showMessage('login-message', 'Login successful! Redirecting...', 'success');
          setTimeout(() => {
            window.location.href = 'seller-dashboard.html';
          }, 1500);
          
        } else {
          // Handle specific error cases
          if (data.requiresVerification) {
            document.getElementById('resend-email').value = email;
            loginFormDiv.classList.add('hidden');
            verificationFormDiv.classList.remove('hidden');
            showMessage('verification-message', data.message, 'warning');
          } else {
            throw new Error(data.message || 'Login failed');
          }
        }
        
      } catch (error) {
        console.error('Login error:', error);
        showMessage('login-message', error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    });
    
    // Register form handler
    registerForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value.trim();
      const submitBtn = document.getElementById('register-btn');
      
      clearMessage('register-message');
      
      // Client-side validation
      if (password.length < 8) {
        showMessage('register-message', 'Password must be at least 8 characters long', 'error');
        return;
      }
      
      if (!/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])/.test(password)) {
        showMessage('register-message', 'Password must contain uppercase, lowercase, number, and special character', 'error');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'Registering...';
      
      try {
        const response = await fetch(`${API_URL}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            name, 
            email, 
            password, 
            role: 'farmer'
          })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          // Show verification form
          document.getElementById('resend-email').value = email;
          registerFormDiv.classList.add('hidden');
          verificationFormDiv.classList.remove('hidden');
          showMessage('verification-message', data.message, 'success');
        } else {
          if (data.requiresVerification) {
            // User exists but not verified
            document.getElementById('resend-email').value = email;
            registerFormDiv.classList.add('hidden');
            verificationFormDiv.classList.remove('hidden');
            showMessage('verification-message', data.message, 'warning');
          } else {
            throw new Error(data.message || 'Registration failed');
          }
        }
        
      } catch (error) {
        console.error('Registration error:', error);
        showMessage('register-message', error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register as Farmer';
      }
    });
    
    // Resend verification email
    resendForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const email = document.getElementById('resend-email').value.trim();
      const submitBtn = document.getElementById('resend-btn');
      
      clearMessage('verification-message');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';
      
      try {
        const response = await fetch(`${API_URL}/auth/resend-verification`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showMessage('verification-message', 'Verification email sent! Please check your inbox.', 'success');
        } else {
          throw new Error(data.message || 'Failed to send verification email');
        }
        
      } catch (error) {
        console.error('Resend verification error:', error);
        showMessage('verification-message', error.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Resend Verification Email';
      }
    });

    // Check if already logged in
    window.addEventListener('DOMContentLoaded', () => {
      const authToken = localStorage.getItem('authToken');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if (authToken && user.role === 'farmer') {
        // Verify token is still valid
        fetch(`${API_URL}/auth/me`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.user.role === 'farmer' && data.user.isEmailVerified) {
            window.location.href = 'seller-dashboard.html';
          }
        })
        .catch(error => {
          // Token is invalid, remove it
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
        });
      }
    });
  </script>
</body>
</html>